<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,700,0,0&display=swap" rel="stylesheet">
<style>
body{margin:0;background:#F9F5EC;font-family:'Inter',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
#chat{flex:1;overflow-y:auto;padding:16px;padding-bottom:calc(112px + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:12px;}
.bubble{max-width:80%;padding:12px 16px;border-radius:24px;line-height:1.4;animation:fadeIn .3s ease both;}
.user{align-self:flex-end;background:#E5ECFA;}
.bot{align-self:flex-start;background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);}
#controls{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:center;padding:8px calc(16px + env(safe-area-inset-left)) calc(8px + env(safe-area-inset-bottom)) calc(16px + env(safe-area-inset-right));gap:8px;}
#input{flex:1;max-width:600px;display:flex;gap:8px;}
#msg{flex:1;border:none;border-radius:999px;padding:12px 16px;background:rgba(255,255,255,0.6);backdrop-filter:blur(20px);font-size:16px;outline:none;}
#send{border:none;border-radius:999px;background:rgba(255,255,255,0.6);backdrop-filter:blur(20px);width:48px;height:48px;display:flex;align-items:center;justify-content:center;transition:background .3s;}
#send:active{transform:scale(0.95);}
.material-symbols-rounded{font-variation-settings:'FILL' 0,'wght' 700,'GRAD' 0,'opsz' 24;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
#loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#F9F5EC;transition:opacity .4s;}
#loader.hidden{opacity:0;pointer-events:none;}
.spin{animation:spin 1s linear infinite;}
@keyframes spin{from{transform:rotate(0);}to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div id="chat"></div>
<div id="controls">
  <div id="input">
    <input id="msg" placeholder="Message" autocomplete="off">
    <button id="send"><span class="material-symbols-rounded">send</span></button>
  </div>
</div>
<div id="loader"><span class="material-symbols-rounded spin">hourglass_top</span></div>
<script>
const chat=document.getElementById('chat');
const msg=document.getElementById('msg');
const sendBtn=document.getElementById('send');
const loader=document.getElementById('loader');
const convo=[];

async function pullModel(){
  try{
    await fetch('http://localhost:11434/api/pull',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'llama3.1'})
    });
  }catch(e){console.error(e);}
  loader.classList.add('hidden');
  msg.focus();
}

function addBubble(text,who){
  const div=document.createElement('div');
  div.className='bubble '+who;
  div.textContent=text;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
}

async function ask(){
  const text=msg.value.trim();
  if(!text) return;
  msg.value='';
  addBubble(text,'user');
  convo.push({role:'user',content:text});
  const botDiv=document.createElement('div');
  botDiv.className='bubble bot';
  botDiv.textContent='';
  chat.appendChild(botDiv);
  chat.scrollTop=chat.scrollHeight;
  const res=await fetch('http://localhost:11434/api/chat',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({model:'llama3.1',messages:convo,stream:true})
  });
  const reader=res.body.getReader();
  const decoder=new TextDecoder();
  let buf='';
  while(true){
    const {value,done}=await reader.read();
    if(done) break;
    buf+=decoder.decode(value,{stream:true});
    const lines=buf.split('\n');
    buf=lines.pop();
    for(const line of lines){
      if(!line) continue;
      const data=JSON.parse(line);
      if(data.message?.content){
        botDiv.textContent+=data.message.content;
        chat.scrollTop=chat.scrollHeight;
      }
    }
  }
  convo.push({role:'assistant',content:botDiv.textContent});
}

sendBtn.addEventListener('click',ask);
msg.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();ask();}});

pullModel();
</script>
</body>
</html>
