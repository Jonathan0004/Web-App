<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vision</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@500&display=swap" rel="stylesheet" />
  <style>
    body{margin:0;background:#F9F5EC;font-family:'DM Sans',sans-serif;overflow:hidden;}
    video,canvas{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;}
    #controls{position:fixed;left:50%;bottom:0;transform:translate(-50%,20px);padding:0 16px calc(env(safe-area-inset-bottom) + 16px);display:flex;gap:16px;opacity:0;transition:transform .4s ease,opacity .4s ease;}
    #controls.show{transform:translate(-50%,0);opacity:1;}
    .pill{padding:12px 24px;border-radius:9999px;backdrop-filter:blur(12px);background:rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .3s ease,opacity .3s ease;}
    .pill:active{transform:scale(.95);opacity:.8;}
    .pill span{font-size:24px;line-height:0;}
    canvas{pointer-events:none;}
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="controls"><div class="pill" id="toggle"><span class="material-symbols-rounded">search</span></div></div>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
  <script>
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const ctx=canvas.getContext('2d');
    const controls=document.getElementById('controls');
    requestAnimationFrame(()=>controls.classList.add('show'));
    let model,active=true;
    async function setupCamera(){
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      video.srcObject=stream;
      await new Promise(r=>video.onloadedmetadata=r);
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
    }
    async function load(){
      model=await cocoSsd.load({base:'mobilenet_v2'});
    }
    function roundRect(x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.lineTo(x+w-r,y);
      ctx.quadraticCurveTo(x+w,y,x+w,y+r);
      ctx.lineTo(x+w,y+h-r);
      ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
      ctx.lineTo(x+r,y+h);
      ctx.quadraticCurveTo(x,y+h,x,y+h-r);
      ctx.lineTo(x,y+r);
      ctx.quadraticCurveTo(x,y,x+r,y);
      ctx.closePath();
    }
    async function loop(){
      if(active){
        const preds=await model.detect(video);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.lineWidth=2;
        ctx.font="16px 'DM Sans'";
        ctx.textBaseline='top';
        preds.forEach(p=>{
          const [x,y,w,h]=p.bbox;
          roundRect(x,y,w,h,12);
          ctx.strokeStyle='rgba(255,255,255,0.7)';
          ctx.stroke();
          const text=p.class;
          const tw=ctx.measureText(text).width+16;
          let ty=y-28; if(ty<0) ty=y+h;
          ctx.fillStyle='rgba(0,0,0,0.6)';
          roundRect(x,ty,tw,24,12);
          ctx.fill();
          ctx.fillStyle='#fff';
          ctx.fillText(text,x+8,ty+5);
        });
      }
      requestAnimationFrame(loop);
    }
    document.getElementById('toggle').addEventListener('click',()=>{
      active=!active;
      if(!active) ctx.clearRect(0,0,canvas.width,canvas.height);
    });
    (async()=>{await setupCamera();await load();loop();})();
  </script>
</body>
</html>
